#!/bin/bash 

P=$1

mkdir $P.AppDir
cd $P.AppDir
sudo apt-get clean
sudo apt-get -y --force-yes --download-only install $P
find /var/cache/apt/archives/*.deb -exec dpkg-deb -x {} . \;
cp $(find . -name *.desktop | grep $P | head -n 1) . || echo ".desktop not found"
find . -type f -exec sed -i -e "s|/usr|././|g" {} \;

if [ -e "./etc" ] ; then
    cd usr/
    ln -s ../etc ./et
    find . -type f -exec sed -i -e "s|/etc|./et|g" {} \;
    cd -
fi

mkdir -p ./usr/bin ./usr/share ./usr/lib

if [ -e "./usr/bin" ] ; then
    cd usr/bin
    ln -s /usr/bin/python /usr/bin/perl /usr/bin/env .
    cd -
fi

# Do something like
# find usr/share/pyshared -type d -exec touch {}/__init__.py \;
# usr/lib/python*/*-packages

# mv /usr/lib/pyshared/python*/* usr/bin/

base64 -d > ./AppRun <<\EOF
f0VMRgEBAQAAAAAAAAAAAAIAAwABAAAAsIcECDQAAABkEQAAAAAAADQAIAAIACgAGgAZAAYAAAA0
AAAANIAECDSABAgAAQAAAAEAAAUAAAAEAAAAAwAAADQBAAA0gQQINIEECBMAAAATAAAABAAAAAEA
AAABAAAAAAAAAACABAgAgAQI/A0AAPwNAAAFAAAAABAAAAEAAAAMDwAADJ8ECAyfBAhIAQAAVAEA
AAYAAAAAEAAAAgAAACAPAAAgnwQIIJ8ECNAAAADQAAAABgAAAAQAAAAEAAAASAEAAEiBBAhIgQQI
JAAAACQAAAAEAAAABAAAAFHldGQAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAEAAAAUuV0ZAwPAAAM
nwQIDJ8ECPQAAAD0AAAABAAAAAEAAAAvbGliL2xkLWxpbnV4LnNvLjIAAAQAAAAUAAAAAwAAAEdO
VQCMMA9fIQkyOtKd4qJ2CoC0agc13hEAAAAYAAAAAAAAAAAAAAAOAAAACgAAAAkAAAAAAAAAFAAA
AAYAAAAEAAAADQAAABAAAAATAAAAEQAAABUAAAAAAAAADwAAAAAAAAAAAAAAAAAAAAEAAAAAAAAA
AAAAAAAAAAADAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAFAAAAAAAAABcAAAACAAAADAAAAAgAAAAW
AAAACwAAAAAAAAASAAAAAAAAAAAAAAACAAAAFgAAAAEAAAAFAAAAACACIgAAAAAWAAAArEvjwDny
ixwAAAAAAAAAAAAAAAAAAAAAagAAAAAAAAAAAAAAEgAAAAEAAAAAAAAAAAAAACAAAABcAAAAAAAA
AAAAAAASAAAAlgAAAAAAAAAAAAAAEgAAAKsAAAAAAAAAAAAAABIAAADQAAAAAAAAAAAAAAASAAAA
4gAAAAAAAAAAAAAAEgAAALMAAAAAAAAAAAAAABIAAACNAAAAAAAAAAAAAAASAAAAfwAAAAAAAAAA
AAAAEgAAAKQAAAAAAAAAAAAAABIAAAA9AAAAAAAAAAAAAAASAAAAKQAAAAAAAAAAAAAAEgAAAGQA
AAAAAAAAAAAAABIAAAB4AAAAAAAAAAAAAAASAAAAhgAAAAAAAAAAAAAAEgAAAEsAAAAAAAAAAAAA
ABIAAAC7AAAAAAAAAAAAAAASAAAAQwAAAAAAAAAAAAAAEgAAAMkAAAAAAAAAAAAAABIAAAA4AAAA
AAAAAAAAAAASAAAAGgAAAGiMBAgEAAAAEQAPAJ0AAABUoAQIBAAAABEAFwAAX19nbW9uX3N0YXJ0
X18AbGliYy5zby42AF9JT19zdGRpbl91c2VkAF9feHBnX2Jhc2VuYW1lAGV4aXQAZm9wZW4Ac3Ry
bmNtcABfX3N0YWNrX2Noa19mYWlsAGRpcm5hbWUAY2hkaXIAX19mcHJpbnRmX2NoawBwdXRlbnYA
ZmNsb3NlAG1hbGxvYwByZWFscGF0aABnZXRlbnYAc3RkZXJyAGV4ZWN2cABzY2FuZGlyAGdldGxp
bmUAX19zcHJpbnRmX2NoawBzdHJjbXAAX19saWJjX3N0YXJ0X21haW4AZnJlZQBHTElCQ18yLjQA
R0xJQkNfMi4xAEdMSUJDXzIuMwBHTElCQ18yLjAAR0xJQkNfMi4zLjQAAAAAAgAAAAMAAwADAAMA
AwADAAQABQADAAUAAwADAAMAAwAGAAIAAwADAAMAAQADAAEABQAQAAAAEAAAAAAAAAAUaWkNAAAG
AOcAAAAQAAAAEWlpDQAABQDxAAAAEAAAABNpaQ0AAAQA+wAAABAAAAAQaWkNAAADAAUBAAAQAAAA
dBlpCQAAAgAPAQAAAAAAAPCfBAgGAgAAVKAECAUXAAAAoAQIBwEAAASgBAgHAgAACKAECAcDAAAM
oAQIBwQAABCgBAgHBQAAFKAECAcGAAAYoAQIBwcAABygBAgHCAAAIKAECAcJAAAkoAQIBwoAACig
BAgHCwAALKAECAcMAAAwoAQIBw0AADSgBAgHDgAAOKAECAcPAAA8oAQIBxAAAECgBAgHEQAARKAE
CAcSAABIoAQIBxMAAEygBAgHFAAAUKAECAcVAABVieVTg+wE6AAAAABbgcPIGQAAi5P8////hdJ0
BeguAAAA6PkBAADo1AUAAFhbycP/NfifBAj/JfyfBAgAAAAA/yUAoAQIaAAAAADp4P////8lBKAE
CGgIAAAA6dD/////JQigBAhoEAAAAOnA/////yUMoAQIaBgAAADpsP////8lEKAECGggAAAA6aD/
////JRSgBAhoKAAAAOmQ/////yUYoAQIaDAAAADpgP////8lHKAECGg4AAAA6XD/////JSCgBAho
QAAAAOlg/////yUkoAQIaEgAAADpUP////8lKKAECGhQAAAA6UD/////JSygBAhoWAAAAOkw////
/yUwoAQIaGAAAADpIP////8lNKAECGhoAAAA6RD/////JTigBAhocAAAAOkA/////yU8oAQIaHgA
AADp8P7///8lQKAECGiAAAAA6eD+////JUSgBAhoiAAAAOnQ/v///yVIoAQIaJAAAADpwP7///8l
TKAECGiYAAAA6bD+////JVCgBAhooAAAAOmg/v//Me1eieGD5PBQVFJosIsECGjAiwQIUVZoY4gE
COjf/v//9JCQkJCQkJCQkJCQkJCQVYnlU4PsBIA9WKAECAB1P6FcoAQIuxifBAiB6xSfBAjB+wKD
6wE52HMejbYAAAAAg8ABo1ygBAj/FIUUnwQIoVygBAg52HLoxgVYoAQIAYPEBFtdw410JgCNvCcA
AAAAVYnlg+wYoRyfBAiFwHQSuAAAAACFwHQJxwQkHJ8ECP/QycONTCQEg+Tw/3H8VYnlV1ZTUYHs
MAEAAItJBGWhFAAAAIlF5DHAiY3M/v//agBobIwECOhG/v//g8QQhcB1CFNoe4wECOs6g+wMUOjO
/f//jZ3l/v//iQQkaM6NBAho/wAAAGoBU+ij/v//g8QUU+ha/v//g8QQhcB0H1Noo4wECGoB/zVU
oAQI6HD9///HBCQBAAAA6KT+//9qAGhziwQIjYXg/v//UGjAjAQI6Iz9//+DxBCFwHUIUWjCjAQI
68BAdQhTaOKMBAjrtVJSaFuNBAiLheD+//+Nvdz+//+LAIPAC1DoxP3//8cEJP8AAACJw+j2/f//
g8QQx4XY/v///wAAAImF3P7//+s7i7Xc/v//UGoFaAaNBAhW6P39//+DxBCFwHUgg8YFRooGhMB0
DDwgdAg8JXQEPAp17cYGAL4BAAAA6xdWU42V2P7//1JX6Bf9//+DxBBAdbAx9oPsDFPoJv3//4PE
EIX2dQtTaAyNBAjpB////4uF3P7//4PsDIPABVDoMv3//4mF0P7//8cEJFmNBAjoMP3//4PEEIXA
dApoWY0ECOnN/v//g+wMaF2NBAjocvz//4PEEIXAicN1BbtYjQQIMcCDyf+J34PsDPKu99GDwRdR
6A39//+JhdT+//+JHCRobY0ECGr/agFQ6BX9//+DxBT/tdT+///o1/z//8cEJKyNBAjoG/z//4PE
EIXAicN1BbtYjQQIMcCDyf+J34PsDPKu99GDwR5R6Lb8//+JHCRoho0ECGr/agFQicbowvz//4PE
FFboifz//8cEJKaNBAjozfv//4PEEIXAicN1BbtYjQQIMcCDyf+J34PsDPKu99GDwR5R6Gj8//+J
HCRosY0ECGr/agFQicfodPz//4PEFFfoO/z//1pZ/7XM/v///7XQ/v//6Oj7//+DxBBAdRSLhdz+
//+DwAVQaNGNBAjpsf3//4PsDP+11P7//+iA+///iTQk6Hj7//9Y/7Xc/v//6Gz7//8xwItV5GUz
FRQAAAB0Bej5+///jWXwWVteX12NYfzDVYnlg+wIi0UIg8ALQIA4AHX6SIA4LnX6UlJo7o0ECFDo
+Pv//4PEEMmFwA+UwA+2wMOQkJCQkJCQkJCQkFWJ5V3DjXQmAI28JwAAAABVieVXVlPoTwAAAIHD
KRQAAIPsHOhH+v//jbsY////jYMY////KcfB/wKF/3QkMfaLRRCJRCQIi0UMiUQkBItFCIkEJP+U
sxj///+DxgE5/nLeg8QcW15fXcOLHCTDkJBVieVTg+wEoQyfBAiD+P90E7sMnwQIZpCD6wT/0IsD
g/j/dfSDxARbXcMAAFWJ5VOD7AToAAAAAFuBw5wTAADofPv//1lbycMBAAIAL3Byb2Mvc2VsZi9l
eGUARXJyb3I6IENvdWxkIG5vdCBhY2Nlc3MgL3Byb2Mvc2VsZi9leGUKAEVycm9yOiBDb3VsZCBu
b3QgY2QgaW50byAlcwoALgBFcnJvcjogTm8gLmRlc2t0b3AgZmlsZXMgZm91bmQKAEVycm9yOiBD
b3VsZCBub3Qgc2NhbiBkaXJlY3RvcnkgJXMKAEV4ZWM9AEVycm9yOiBFeGVjdXRhYmxlIG5vdCBm
b3VuZCwgbWFrZSBzdXJlIHRoZXJlJ3MgYSBsaW5lIHN0YXJ0aW5nIHdpdGggJ0V4ZWM9JwoAdXNy
AExEX0xJQlJBUllfUEFUSABMRF9MSUJSQVJZX1BBVEg9Li9saWI6JXMAUEFUSD0uL2Jpbi86Li9z
YmluLzouL2dhbWVzLzolcwBQWVRIT05QQVRIAFBZVEhPTlBBVEg9Li9zaGFyZS9weXNoYXJlZC86
JXMARXJyb3I6IEVycm9yIGV4ZWN1dGluZyAnJXMnCgAuZGVza3RvcAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////wAAAAD/////AAAAAAAAAAABAAAA
EAAAAAwAAAAghgQIDQAAAEyMBAgEAAAAbIEECPX+/28YggQIBQAAALyDBAgGAAAAPIIECAoAAAAb
AQAACwAAABAAAAAVAAAAAAAAAAMAAAD0nwQIAgAAAKgAAAAUAAAAEQAAABcAAAB4hQQIEQAAAGiF
BAgSAAAAEAAAABMAAAAIAAAA/v//bwiFBAj///9vAQAAAPD//2/YhAQIAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACCfBAgAAAAAAAAAAGaGBAh2hgQI
hoYECJaGBAimhgQItoYECMaGBAjWhgQI5oYECPaGBAgGhwQIFocECCaHBAg2hwQIRocECFaHBAhm
hwQIdocECIaHBAiWhwQIpocECEdDQzogKFVidW50dSA0LjQuMy0zdWJ1bnR1MykgNC40LjMAR0ND
OiAoVWJ1bnR1IDQuNC4zLTN1YnVudHUxKSA0LjQuMwAALnNoc3RydGFiAC5pbnRlcnAALm5vdGUu
Z251LmJ1aWxkLWlkAC5nbnUuaGFzaAAuZHluc3ltAC5keW5zdHIALmdudS52ZXJzaW9uAC5nbnUu
dmVyc2lvbl9yAC5yZWwuZHluAC5yZWwucGx0AC5pbml0AC50ZXh0AC5maW5pAC5yb2RhdGEALmVo
X2ZyYW1lAC5jdG9ycwAuZHRvcnMALmpjcgAuZHluYW1pYwAuZ290AC5nb3QucGx0AC5ic3MALmNv
bW1lbnQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsAAAABAAAAAgAA
ADSBBAg0AQAAEwAAAAAAAAAAAAAAAQAAAAAAAAATAAAABwAAAAIAAABIgQQISAEAACQAAAAAAAAA
AAAAAAQAAAAAAAAAKgAAAAUAAAACAAAAbIEECGwBAACsAAAABQAAAAAAAAAEAAAABAAAACYAAAD2
//9vAgAAABiCBAgYAgAAJAAAAAUAAAAAAAAABAAAAAQAAAAwAAAACwAAAAIAAAA8ggQIPAIAAIAB
AAAGAAAAAQAAAAQAAAAQAAAAOAAAAAMAAAACAAAAvIMECLwDAAAbAQAAAAAAAAAAAAABAAAAAAAA
AEAAAAD///9vAgAAANiEBAjYBAAAMAAAAAUAAAAAAAAAAgAAAAIAAABNAAAA/v//bwIAAAAIhQQI
CAUAAGAAAAAGAAAAAQAAAAQAAAAAAAAAXAAAAAkAAAACAAAAaIUECGgFAAAQAAAABQAAAAAAAAAE
AAAACAAAAGUAAAAJAAAAAgAAAHiFBAh4BQAAqAAAAAUAAAAMAAAABAAAAAgAAABuAAAAAQAAAAYA
AAAghgQIIAYAADAAAAAAAAAAAAAAAAQAAAAAAAAAaQAAAAEAAAAGAAAAUIYECFAGAABgAQAAAAAA
AAAAAAAEAAAABAAAAHQAAAABAAAABgAAALCHBAiwBwAAmgQAAAAAAAAAAAAAEAAAAAAAAAB6AAAA
AQAAAAYAAABMjAQITAwAABwAAAAAAAAAAAAAAAQAAAAAAAAAgAAAAAEAAAACAAAAaIwECGgMAACP
AQAAAAAAAAAAAAAEAAAAAAAAAIgAAAABAAAAAgAAAPiNBAj4DQAABAAAAAAAAAAAAAAABAAAAAAA
AACSAAAAAQAAAAMAAAAMnwQIDA8AAAgAAAAAAAAAAAAAAAQAAAAAAAAAmQAAAAEAAAADAAAAFJ8E
CBQPAAAIAAAAAAAAAAAAAAAEAAAAAAAAAKAAAAABAAAAAwAAAByfBAgcDwAABAAAAAAAAAAAAAAA
BAAAAAAAAAClAAAABgAAAAMAAAAgnwQIIA8AANAAAAAGAAAAAAAAAAQAAAAIAAAArgAAAAEAAAAD
AAAA8J8ECPAPAAAEAAAAAAAAAAAAAAAEAAAABAAAALMAAAABAAAAAwAAAPSfBAj0DwAAYAAAAAAA
AAAAAAAABAAAAAQAAAC8AAAACAAAAAMAAABUoAQIVBAAAAwAAAAAAAAAAAAAAAQAAAAAAAAAwQAA
AAEAAAAwAAAAAAAAAFQQAABGAAAAAAAAAAAAAAABAAAAAQAAAAEAAAADAAAAAAAAAAAAAACaEAAA
ygAAAAAAAAAAAAAAAQAAAAAAAAA=
EOF

chmod a+x ./AppRun

# Create AppImage and test it on the supported distros. 

# Problematic libs:
# cp /usr/lib/libtiff.so.4 usr/lib/
# cp /usr/lib/libmms.so.* usr/lib/
# cp /lib/libbz2.so.* usr/lib/
# cp /usr/lib/libjpeg.* usr/lib/
# cp /usr/lib/libmad.so.* usr/lib/
# cp /usr/lib/libfribidi.so.* usr/lib/
# cp /lib/libpcre.so.* usr/lib/
# cp /usr/lib/libenca.so.* usr/lib/
# cp /usr/lib/libpng* usr/lib/
# cp /usr/lib/libhal-storage.so.* usr/lib/
# cp /usr/lib/libhal.so.* usr/lib/
# cp /usr/lib/libSDL-1.2.so.* usr/lib/
# cp /lib/libcrypto.so.* usr/lib/
# cp /usr/lib/libdirectfb* usr/lib/
# cp /usr/lib/libfusion* usr/lib/
# cp /usr/lib/libdirect* usr/lib/
# 
# 
# 
# 
# 
# 
# 
# 
